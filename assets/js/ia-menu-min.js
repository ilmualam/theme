/*! PBT MEGA Menu v2.0 - Smart Caching System | (c) 2025 | Minified */
!function(e){"use strict";const t={cache:new Map,activeRequests:new Map,config:{cacheExpiry:3e5,maxCacheSize:20,retryAttempts:2,requestDelay:300},init(){this.setupMenus(),this.preloadPopularCategories(),this.setupIntersectionObserver()},setupMenus(){document.querySelectorAll(".has-mega").forEach(e=>{const t=e.querySelector("a"),n=t?.dataset.shortcode;if(!n)return;const a=this.getShortcodeAttr(n,"label")||"recent";a.includes("/")?this.setupTabsMenu(e,a.split("/")):this.setupSingleMenu(e,a)})},setupSingleMenu(e,t){const n="recent"===t?"/search":`/search/label/${t}`;e.classList.add("type-mega"),e.querySelector("a").href=n;let a;e.addEventListener("mouseenter",()=>{clearTimeout(a),a=setTimeout(()=>{this.loadMenuContent(e,t)},150)}),e.addEventListener("mouseleave",()=>{clearTimeout(a)})},setupTabsMenu(e,t){e.classList.add("type-tabs");const n=this.generateTabsHTML(t.slice(0,4)),a=e.querySelector(".mega");a&&(a.innerHTML=n,this.bindTabEvents(e,t))},generateTabsHTML(e){const t=e.map((e,t)=>`<a href="/search/label/${e}" ${0===t?'class="active"':""}>${e}</a>`).join(""),n=e.map((e,t)=>`<div data-tab="${e}" ${0===t?'class="active"':""}></div>`).join("");return`<div class="mega-tabs"><div class="nav">${t}</div><div class="tabs">${n}</div></div>`},bindTabEvents(e,t){const n=e.querySelectorAll(".nav a"),a=e.querySelectorAll("[data-tab]");e.addEventListener("mouseenter",()=>{const e=a[0];e&&!e.classList.contains("loaded")&&this.loadTabContent(e,e.dataset.tab)},{once:!0}),n.forEach((e,s)=>{e.addEventListener("mouseenter",()=>{n.forEach(e=>e.classList.remove("active")),a.forEach(e=>e.classList.remove("active")),e.classList.add("active");const r=a[s];r.classList.add("active"),r.classList.contains("loaded")||this.loadTabContent(r,t[s])})})},async loadMenuContent(e,t,n="mega"){if(e.classList.contains("loaded"))return;const a=e.querySelector(".mega");if(!a)return;e.classList.add("loaded");try{const e=await this.fetchPosts(t,5),s=this.renderPosts(e,n);a.innerHTML=`<div class="mega-items">${s}</div>`,this.lazyLoadImages(a)}catch(s){console.warn("Failed to load mega menu content:",s),a.innerHTML=this.getErrorHTML()}},async loadTabContent(e,t){if(e.classList.contains("loaded"))return;e.classList.add("loaded"),e.innerHTML=this.getLoaderHTML();try{const n=await this.fetchPosts(t,5),a=this.renderPosts(n,"megatabs");e.innerHTML=a,this.lazyLoadImages(e)}catch(n){console.warn("Failed to load tab content:",n),e.innerHTML=this.getErrorHTML()}},async fetchPosts(e,t){const n=`${e}-${t}`,a=this.cache.get(n);if(a&&Date.now()-a.timestamp<this.config.cacheExpiry)return a.data;if(this.activeRequests.has(n))return this.activeRequests.get(n);const s=this.getFeedUrl(e,t),r=this.fetchWithRetry(s).then(e=>(this.setCache(n,e),this.activeRequests.delete(n),e)).catch(e=>{throw this.activeRequests.delete(n),e});return this.activeRequests.set(n,r),r},async fetchWithRetry(e,t=1){try{const n=await fetch(e,{method:"GET",headers:{Accept:"text/html,application/xhtml+xml","Cache-Control":"max-age=300"}});if(!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);const a=await n.text();return this.parsePostData(a)}catch(n){if(t<=this.config.retryAttempts)return console.warn(`Fetch attempt ${t} failed, retrying...`,n),await this.delay(1e3*t),this.fetchWithRetry(e,t+1);throw n}},parsePostData(e){const t=(new DOMParser).parseFromString(e,"text/html").querySelector("#data");if(!t)throw new Error("No data element found");try{return JSON.parse(t.textContent).posts||[]}catch(n){throw new Error("Failed to parse JSON data")}},renderPosts(e,t){return e&&e.length?e.map((e,n)=>this.getPostHTML(e,n,t)).join(""):this.getErrorHTML()},getPostHTML(e,t,n){const a=(t/10).toFixed(1),s="megatabs"===n?2:2;return`<div class="post fadeInDown" style="animation-delay:${a}s;"><a class="entry-thumbnail" href="${e.link}"><div class="thumbnail" data-src="${e.thumbnail?.src||""}"></div>${"youtube"===e.thumbnail?.source?`<div class="yt-img:x${s}"></div>`:""}${e.category?`<span class="entry-tag">${e.category}</span>`:""}</a><div class="entry-header"><h2 class="entry-title"><a href="${e.link}">${e.title}</a></h2><div class="entry-meta"><div class="entry-time"><time class="published" datetime="${e.published?.datetime||""}">${e.published?.date||""}</time></div></div></div></div>`},getFeedUrl(e,t){return"recent"===e?`/search/?by-date=true&max-results=${t}&view=json`:`/search/label/${e}?by-date=true&max-results=${t}&view=json`},getShortcodeAttr(e,t){const n=new RegExp(`${t}=([^}]*)`).exec(e);return n?n[1].trim():null},setCache(e,t){this.cache.size>=this.config.maxCacheSize&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,{data:t,timestamp:Date.now()})},lazyLoadImages(e){const t=e.querySelectorAll(".thumbnail[data-src]");window.PBT&&window.PBT.Lazy&&window.PBT.Lazy.init(t,{onScroll:!1})},preloadPopularCategories(){setTimeout(()=>{["recent","technology","news","tutorial"].forEach(e=>{this.fetchPosts(e,5).catch(()=>{})})},2e3)},setupIntersectionObserver(){const e=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target.querySelector("a[data-shortcode]"),n=t?.dataset.shortcode;if(n){const e=this.getShortcodeAttr(n,"label")||"recent";e.includes("/")||this.fetchPosts(e,5).catch(()=>{})}e.unobserve(e.target)}})},{rootMargin:"100px"});document.querySelectorAll(".has-mega").forEach(t=>{e.observe(t)})},getLoaderHTML:()=>'<div class="loader"><svg viewBox="0 0 50 50"><circle stroke-width="2.8" cx="25" cy="25" fill="none" r="20" stroke="currentColor" stroke-linecap="round"></circle></svg></div>',getErrorHTML:()=>'<span class="error-msg">Failed to load content</span>',delay:e=>new Promise(t=>setTimeout(t,e))};e.PBTMegaMenu=t,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>t.init()):t.init()}(window);
